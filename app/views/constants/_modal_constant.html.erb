<div id="constant-modal"
     class="hidden fixed inset-0 bg-black/30 backdrop-blur-sm flex items-start justify-center p-4 z-50 overflow-y-auto"
     data-action="click->modal#handleBackdropClick">
  <div class="bg-white rounded-lg shadow-xl w-full max-w-md mt-20 p-6 relative">
    <button type="button"
            data-action="click->modal#close"
            class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <div class="mt-3">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Nueva Lectura</h3>

      <%= turbo_frame_tag "constant_form", data: { turbo: false } do %>
        <%= form_with(model: Constant.new,
                     data: {
                       controller: "form",
                       action: "turbo:submit-end->modal#handleSuccess turbo:submit-end->form#reset",
                       turbo_stream: true,
                       turbo_frame: "_top"
                     }) do |form| %>
          <div class="bg-white px-6 py-8 shadow rounded-lg">
            <div class="space-y-6">
              <div data-controller="patient-search" class="relative">
                <%= form.label :patient_id, "Paciente", class: "block text-sm font-medium text-gray-700 mb-1" %>

                <%= form.hidden_field :patient_id, data: { patient_search_target: "hidden" } %>

                <input
                  type="text"
                  placeholder="Buscar paciente..."
                  class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md transition duration-150 ease-in-out"
                  data-patient-search-target="input"
                  data-action="input->patient-search#search"
                  autocomplete="off"
                  value="<%= @constant&.patient&.name if @constant&.patient.present? %>"
                />

                <div
                  data-patient-search-target="results"
                  class="absolute left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-lg max-h-60 overflow-y-auto z-50 hidden"
                ></div>
              </div>

                <div data-controller="type-constant">
                  <div>
                    <%= form.label :constant_type_id, "Tipo de Constante", class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <%= form.select :constant_type_id,
                      options_for_select(
                        [['Seleccione un tipo', '']] +
                          ConstantType.all.map { |t|
                          ["#{t.name} (#{t.unit})", t.id, { data: { symbol: t.unit } }]
                        },
                        @constant&.constant_type_id
                      ),
                      {},
                      {
                        id: "constant_constant_type_id",
                        class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md transition duration-150 ease-in-out",
                        data: {
                          type_constant_target: "select",
                          action: "change->type-constant#updateUnit"
                        }
                      } %>
                  </div>

                  <div class="mt-4">
                    <%= form.label :value, "Valor", class: "block text-sm font-medium text-gray-700 mb-1" %>
                    <div class="mt-1 flex rounded-md shadow-sm">
                      <%= form.number_field :value, step: "any",
                            class: "focus:ring-indigo-500 focus:border-indigo-500 flex-1 block w-full rounded-none rounded-l-md sm:text-sm border-gray-300",
                            placeholder: "0.00" %>
                      <span data-type-constant-target="unit"
                            class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500 text-sm">
                        Unidad
                      </span>
                    </div>
                  </div>
                </div>

                <div>
                  <%= form.label :date_time_taken, "Fecha y Hora de la Constante", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <div class="mt-1 grid grid-cols-2 gap-2 sm:grid-cols-4">
                    <div class="col-span-2">
                      <%= form.date_field :date,
                          value: form.object.date_time_taken&.strftime("%Y-%m-%d") || Time.current.strftime("%Y-%m-%d"),
                          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                    </div>
                    <div class="col-span-2">
                      <%= form.time_field :time,
                          value: form.object.date_time_taken&.strftime("%H:%M") || Time.current.strftime("%H:%M"),
                          class: "block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" %>
                    </div>
                  </div>
                </div>

                <div>
                  <%= form.label :notes, "Notas", class: "block text-sm font-medium text-gray-700 mb-1" %>
                  <%= form.text_area :notes,
                      class: "shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mt-1 block w-full sm:text-sm border border-gray-300 rounded-md",
                      rows: 3,
                      placeholder: "Detalles de la lectura o condiciones del paciente" %>
                </div>
              </div>

              <div class="flex items-center justify-end mt-6 gap-2">
                <%= button_tag "Cancelar",
                      type: "button",
                      data: { action: "click->modal#close" },
                      class: "inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-white bg-[rgb(108_117_125)] hover:bg-[rgb(108_117_125)] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#007bfe] transition-colors duration-200" %>

                <%= form.submit "Guardar",
                      data: { turbo_frame: "_top" },
                      class: "inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-[rgb(40_166_69)] hover:bg-[#2e8b57] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#007bfe] transition-colors duration-200" %>
              </div>
            </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>